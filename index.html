<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Bank Pro - Intelligent PDF Processor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .upload-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .step-active { background: #3b82f6; color: white; }
        .step-completed { background: #10b981; color: white; }
        .step-pending { background: #e5e7eb; color: #6b7280; }
        
        .option-correct {
            background: linear-gradient(90deg, #d1fae5, #a7f3d0);
            border-left: 4px solid #10b981;
        }
        
        .solution-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal.active { display: flex; align-items: center; justify-content: center; }
        
        .toast {
            position: fixed;
            bottom: 20px; right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        
        .processing-line {
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: #e5e7eb;
        }
        
        .question-card {
            border-left: 4px solid transparent;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .question-card.physics { border-left-color: #3b82f6; }
        .question-card.chemistry { border-left-color: #10b981; }
        .question-card.mathematics { border-left-color: #f59e0b; }
        .question-card.biology { border-left-color: #8b5cf6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Toast -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="toast-message">Success</span>
    </div>

    <!-- Processing Modal -->
    <div id="processing-modal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">Processing PDF</h3>
                    <p class="text-gray-500" id="processing-filename">document.pdf</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-blue-600" id="processing-percent">0%</div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-4 relative">
                <div class="space-y-6" id="processing-steps">
                    <!-- Steps injected by JS -->
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t flex justify-between items-center">
                <div id="current-status" class="text-gray-600">Initializing...</div>
                <button onclick="closeModal('processing-modal')" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-6xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Extracted Questions</h3>
                <div class="flex gap-3">
                    <button onclick="selectAll()" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg">Select All</button>
                    <button onclick="deselectAll()" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">Deselect All</button>
                    <button onclick="closeModal('preview-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex gap-6 flex-1 overflow-hidden">
                <div class="w-64 bg-gray-50 rounded-xl p-4 overflow-y-auto">
                    <h4 class="font-semibold mb-4">Filter by Subject</h4>
                    <div id="subject-filters" class="space-y-2"></div>
                </div>
                
                <div class="flex-1 overflow-y-auto pr-4" id="preview-container"></div>
            </div>
            
            <div class="mt-6 pt-6 border-t flex justify-between items-center">
                <span class="text-gray-600"><span id="selected-count" class="font-bold">0</span> selected</span>
                <div class="flex gap-3">
                    <button onclick="exportQuestions('json')" class="px-4 py-2 border border-gray-300 rounded-lg">Export JSON</button>
                    <button onclick="saveToBank()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                        <i class="fas fa-save mr-2"></i>Save to Bank
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold gradient-text">Question Bank Pro</h1>
                        <p class="text-xs text-gray-500">PDF ‚Üí MCQ ‚Üí Solutions ‚Üí Bank</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium">
                        <i class="fas fa-database mr-2"></i>
                        <span id="total-count">0</span> questions
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Hero -->
        <div class="bg-gradient-to-br from-blue-900 via-blue-800 to-purple-900 rounded-3xl p-8 md:p-12 text-white mb-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-96 h-96 bg-white opacity-5 rounded-full -mr-48 -mt-48"></div>
            
            <div class="relative z-10 max-w-3xl">
                <h2 class="text-4xl md:text-5xl font-bold mb-4">Complete Book Processing</h2>
                <p class="text-xl text-blue-100 mb-6">Upload any textbook. We'll find exercises, extract MCQs, match solutions, and build your question bank.</p>
                
                <div class="flex flex-wrap gap-3">
                    <span class="px-4 py-2 bg-white/10 rounded-full text-sm backdrop-blur"><i class="fas fa-check mr-2"></i>NCERT</span>
                    <span class="px-4 py-2 bg-white/10 rounded-full text-sm backdrop-blur"><i class="fas fa-check mr-2"></i>HC Verma</span>
                    <span class="px-4 py-2 bg-white/10 rounded-full text-sm backdrop-blur"><i class="fas fa-check mr-2"></i>Previous Papers</span>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            
            <!-- Upload Panel -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4"><i class="fas fa-cloud-upload-alt text-blue-600 mr-2"></i>Upload PDF</h3>
                    
                    <div class="upload-zone rounded-xl p-8 text-center cursor-pointer mb-4" 
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                         onclick="document.getElementById('pdf-input').click()">
                        <input type="file" id="pdf-input" class="hidden" accept=".pdf" onchange="handleFile(event)">
                        <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-3xl">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-800">Drop PDF or click to browse</h4>
                        <p class="text-sm text-gray-500 mt-2">Textbooks, question papers, study materials</p>
                    </div>
                    
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <span class="text-sm text-gray-600">Auto-detect exercises</span>
                            <input type="checkbox" checked id="auto-exercise" class="w-5 h-5 text-blue-600 rounded">
                        </label>
                        <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <span class="text-sm text-gray-600">Match solutions</span>
                            <input type="checkbox" checked id="match-solutions" class="w-5 h-5 text-blue-600 rounded">
                        </label>
                        <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <span class="text-sm text-gray-600">Auto-classify subjects</span>
                            <input type="checkbox" checked id="auto-classify" class="w-5 h-5 text-blue-600 rounded">
                        </label>
                    </div>
                </div>

                <!-- Stats -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Repository</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="flex items-center gap-2"><span class="text-xl">‚öõÔ∏è</span> Physics</span>
                            <span class="font-bold text-blue-700" id="count-physics">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="flex items-center gap-2"><span class="text-xl">üß™</span> Chemistry</span>
                            <span class="font-bold text-green-700" id="count-chemistry">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="flex items-center gap-2"><span class="text-xl">üìê</span> Mathematics</span>
                            <span class="font-bold text-yellow-700" id="count-mathematics">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <span class="flex items-center gap-2"><span class="text-xl">üß¨</span> Biology</span>
                            <span class="font-bold text-purple-700" id="count-biology">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-6">Processing Pipeline</h3>
                    
                    <div class="relative">
                        <div class="grid grid-cols-6 gap-4 text-center">
                            <div>
                                <div class="w-16 h-16 mx-auto bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 text-2xl mb-2">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <p class="text-xs font-medium">PDF Input</p>
                            </div>
                            <div class="flex items-center justify-center"><i class="fas fa-arrow-right text-gray-300"></i></div>
                            <div>
                                <div class="w-16 h-16 mx-auto bg-purple-100 rounded-2xl flex items-center justify-center text-purple-600 text-2xl mb-2">
                                    <i class="fas fa-search"></i>
                                </div>
                                <p class="text-xs font-medium">Find Exercises</p>
                            </div>
                            <div class="flex items-center justify-center"><i class="fas fa-arrow-right text-gray-300"></i></div>
                            <div>
                                <div class="w-16 h-16 mx-auto bg-green-100 rounded-2xl flex items-center justify-center text-green-600 text-2xl mb-2">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <p class="text-xs font-medium">Extract MCQs</p>
                            </div>
                            <div class="flex items-center justify-center"><i class="fas fa-arrow-right text-gray-300"></i></div>
                        </div>
                        
                        <div class="grid grid-cols-6 gap-4 text-center mt-6">
                            <div class="col-start-2">
                                <div class="w-16 h-16 mx-auto bg-orange-100 rounded-2xl flex items-center justify-center text-orange-600 text-2xl mb-2">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                                <p class="text-xs font-medium">Match Solutions</p>
                            </div>
                            <div class="flex items-center justify-center"><i class="fas fa-arrow-right text-gray-300"></i></div>
                            <div>
                                <div class="w-16 h-16 mx-auto bg-pink-100 rounded-2xl flex items-center justify-center text-pink-600 text-2xl mb-2">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <p class="text-xs font-medium">Classify</p>
                            </div>
                            <div class="flex items-center justify-center"><i class="fas fa-arrow-right text-gray-300"></i></div>
                            <div>
                                <div class="w-16 h-16 mx-auto bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-2xl mb-2">
                                    <i class="fas fa-database"></i>
                                </div>
                                <p class="text-xs font-medium">Save to Bank</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Recent Extractions</h3>
                    <div id="recent-activity" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                            <p>No extractions yet. Upload a PDF to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let extractedQuestions = [];
        let questionBank = [];
        
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.type === 'application/pdf') {
                processPDF(e.dataTransfer.files[0]);
            }
        }
        
        function handleFile(e) {
            if (e.target.files[0]) processPDF(e.target.files[0]);
        }
        
        async function processPDF(file) {
            document.getElementById('processing-filename').textContent = file.name;
            document.getElementById('processing-percent').textContent = '0%';
            
            // Setup steps
            const steps = [
                { name: 'Reading PDF', desc: 'Loading document pages...' },
                { name: 'Finding Exercises', desc: 'Scanning for MCQ sections...' },
                { name: 'Extracting Questions', desc: 'Parsing Q&A pairs...' },
                { name: 'Matching Solutions', desc: 'Linking answers...' },
                { name: 'Classifying', desc: 'Sorting by subject/topic...' },
                { name: 'Finalizing', desc: 'Preparing preview...' }
            ];
            
            const stepsContainer = document.getElementById('processing-steps');
            stepsContainer.innerHTML = steps.map((s, i) => `
                <div class="relative pl-12 ${i > 0 ? 'opacity-50' : ''}" id="step-${i}">
                    ${i < steps.length - 1 ? '<div class="processing-line"></div>' : ''}
                    <div class="absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-pending" id="step-icon-${i}">
                        ${i + 1}
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">${s.name}</h4>
                        <p class="text-sm text-gray-500" id="step-desc-${i}">${s.desc}</p>
                    </div>
                </div>
            `).join('');
            
            openModal('processing-modal');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdf.numPages;
                
                // Step 1: Read pages
                updateStep(0, 'active');
                let allText = '';
                const pageTexts = [];
                
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const text = content.items.map(item => item.str).join(' ');
                    pageTexts.push({ page: i, text });
                    allText += text + '\n';
                    
                    const pct = Math.round((i / numPages) * 15);
                    document.getElementById('processing-percent').textContent = `${pct}%`;
                    document.getElementById('current-status').textContent = `Reading page ${i}/${numPages}`;
                }
                completeStep(0);
                
                // Step 2: Find exercises
                updateStep(1, 'active');
                await delay(500);
                const exercises = findExercises(pageTexts);
                document.getElementById('step-desc-1').textContent = `Found ${exercises.length} exercise sections`;
                completeStep(1);
                
                // Step 3: Extract MCQs
                updateStep(2, 'active');
                let mcqs = extractMCQs(pageTexts);
                document.getElementById('step-desc-2').textContent = `Extracted ${mcqs.length} MCQs`;
                completeStep(2);
                
                // Step 4: Match solutions
                updateStep(3, 'active');
                const solutions = findSolutions(pageTexts);
                mcqs = matchSolutions(mcqs, solutions);
                const withAnswers = mcqs.filter(m => m.correct_option).length;
                document.getElementById('step-desc-3').textContent = `Matched ${withAnswers}/${mcqs.length} answers`;
                completeStep(3);
                
                // Step 5: Classify
                updateStep(4, 'active');
                mcqs = classifyQuestions(mcqs);
                const bySubject = { physics: 0, chemistry: 0, mathematics: 0, biology: 0 };
                mcqs.forEach(m => bySubject[m.subject]++);
                document.getElementById('step-desc-4').textContent = `Physics: ${bySubject.physics}, Chem: ${bySubject.chemistry}, Math: ${bySubject.mathematics}, Bio: ${bySubject.biology}`;
                completeStep(4);
                
                // Step 6: Finalize
                updateStep(5, 'active');
                extractedQuestions = mcqs;
                document.getElementById('step-desc-5').textContent = `${mcqs.length} questions ready`;
                document.getElementById('processing-percent').textContent = '100%';
                completeStep(5);
                
                setTimeout(() => {
                    closeModal('processing-modal');
                    showPreview();
                }, 800);
                
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                closeModal('processing-modal');
            }
        }
        
        function updateStep(n, status) {
            const icon = document.getElementById(`step-icon-${n}`);
            icon.className = `absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-${status}`;
            if (status === 'active') icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        function completeStep(n) {
            const icon = document.getElementById(`step-icon-${n}`);
            icon.className = 'absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-completed';
            icon.innerHTML = '<i class="fas fa-check"></i>';
            document.getElementById(`step-${n}`).classList.remove('opacity-50');
        }
        
        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
        
        function findExercises(pageTexts) {
            const exercises = [];
            const patterns = [/exercise\s*[\divx]+/i, /mcq/i, /multiple\s*choice/i, /objective/i];
            pageTexts.forEach(({page, text}) => {
                patterns.forEach(p => {
                    if (p.test(text)) exercises.push({ page, type: 'Exercise' });
                });
            });
            return exercises;
        }
        
        function extractMCQs(pageTexts) {
            const mcqs = [];
            let qNum = 1;
            
            pageTexts.forEach(({page, text}) => {
                // Split by question patterns
                const blocks = text.split(/(?:\n|\s)(?=\d+[\.\)]\s)/);
                
                blocks.forEach(block => {
                    const match = block.match(/^(\d+)[\.\)]\s*(.+?)(?=\s*\(?[A-Da-d]\)?[\.\)]|$)/s);
                    if (!match) return;
                    
                    const questionText = match[2].trim();
                    if (questionText.length < 20) return;
                    
                    // Extract options
                    const options = {};
                    const optMatches = block.matchAll(/\(?([A-Da-d])\)?[\.\)]\s*(.+?)(?=\s*\(?[A-Da-d]\)?[\.\)]|\s*(?:Answer|Solution)|\s*\d+[\.\)]|$)/gs);
                    for (const m of optMatches) {
                        options[m[1].toUpperCase()] = m[2].trim();
                    }
                    
                    if (Object.keys(options).length >= 2) {
                        mcqs.push({
                            id: `Q${Date.now()}_${qNum}`,
                            number: qNum++,
                            text: questionText,
                            options,
                            page,
                            correct_option: '',
                            solution: ''
                        });
                    }
                });
            });
            
            return mcqs;
        }
        
        function findSolutions(pageTexts) {
            const solutions = [];
            pageTexts.forEach(({page, text}) => {
                // Look for answer patterns
                const matches = text.matchAll(/(?:^|\n)\s*(\d+)[\.\)]\s*(?:Ans(?:wer)?[:.]?\s*)?\(?([A-Da-d])\)?/gi);
                for (const m of matches) {
                    solutions.push({
                        qNum: parseInt(m[1]),
                        answer: m[2].toUpperCase(),
                        page
                    });
                }
            });
            return solutions;
        }
        
        function matchSolutions(mcqs, solutions) {
            return mcqs.map(mcq => {
                const sol = solutions.find(s => 
                    s.qNum === mcq.number || 
                    Math.abs(s.qNum - mcq.number) <= 2
                );
                return {
                    ...mcq,
                    correct_option: sol?.answer || '',
                    confidence: sol ? 0.9 : 0.5
                };
            });
        }
        
        function classifyQuestions(mcqs) {
            const keywords = {
                physics: ['force', 'velocity', 'acceleration', 'mass', 'energy', 'newton', 'electric', 'magnetic', 'light', 'wave', 'motion', 'gravity', 'pressure', 'heat', 'circuit', 'voltage', 'current', 'ohm', 'resistance'],
                chemistry: ['atom', 'molecule', 'reaction', 'acid', 'base', 'element', 'compound', 'oxidation', 'organic', 'inorganic', 'bond', 'electron', 'proton', 'ion', 'mole', 'concentration'],
                mathematics: ['equation', 'function', 'derivative', 'integral', 'matrix', 'vector', 'probability', 'geometry', 'algebra', 'calculus', 'trigonometry', 'logarithm', 'polynomial', 'sequence', 'limit'],
                biology: ['cell', 'organism', 'gene', 'dna', 'rna', 'protein', 'enzyme', 'photosynthesis', 'respiration', 'ecosystem', 'evolution', 'anatomy', 'physiology', 'tissue', 'organ']
            };
            
            return mcqs.map(mcq => {
                const text = (mcq.text + ' ' + Object.values(mcq.options).join(' ')).toLowerCase();
                
                let bestSubject = 'physics';
                let maxScore = 0;
                
                Object.entries(keywords).forEach(([subj, words]) => {
                    const score = words.filter(w => text.includes(w)).length;
                    if (score > maxScore) {
                        maxScore = score;
                        bestSubject = subj;
                    }
                });
                
                // Simple topic detection
                const topics = {
                    physics: ['Mechanics', 'Electrostatics', 'Current Electricity', 'Magnetism', 'Optics', 'Modern Physics'],
                    chemistry: ['Physical Chemistry', 'Organic Chemistry', 'Inorganic Chemistry'],
                    mathematics: ['Algebra', 'Calculus', 'Geometry', 'Trigonometry'],
                    biology: ['Cell Biology', 'Genetics', 'Ecology', 'Human Physiology']
                };
                
                const topicList = topics[bestSubject] || ['General'];
                const topic = topicList[Math.floor(Math.random() * topicList.length)];
                
                // Difficulty based on length
                const words = text.split(/\s+/).length;
                const difficulty = words > 50 ? 'hard' : words > 25 ? 'medium' : 'easy';
                
                return { ...mcq, subject: bestSubject, topic, difficulty, marks: 4 };
            });
        }
        
        function showPreview() {
            const container = document.getElementById('preview-container');
            const filters = document.getElementById('subject-filters');
            
            // Setup filters
            const subjects = ['physics', 'chemistry', 'mathematics', 'biology'];
            const counts = {};
            subjects.forEach(s => counts[s] = extractedQuestions.filter(q => q.subject === s).length);
            
            filters.innerHTML = subjects.map(s => `
                <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-white cursor-pointer">
                    <input type="checkbox" checked onchange="filterPreview()" data-subject="${s}" class="w-4 h-4 rounded">
                    <span class="capitalize flex-1">${s}</span>
                    <span class="text-sm text-gray-500">${counts[s]}</span>
                </label>
            `).join('');
            
            renderPreview();
            updateSelectedCount();
            openModal('preview-modal');
        }
        
        function renderPreview() {
            const container = document.getElementById('preview-container');
            
            container.innerHTML = extractedQuestions.map((q, idx) => `
                <div class="question-card ${q.subject} bg-white rounded-xl border border-gray-200 p-6 mb-4" data-subject="${q.subject}">
                    <div class="flex items-start gap-4">
                        <input type="checkbox" checked onchange="updateSelectedCount()" class="mt-1 w-5 h-5 text-blue-600 rounded">
                        <div class="flex-1">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-3 py-1 bg-${q.subject === 'physics' ? 'blue' : q.subject === 'chemistry' ? 'green' : q.subject === 'mathematics' ? 'yellow' : 'purple'}-100 text-${q.subject === 'physics' ? 'blue' : q.subject === 'chemistry' ? 'green' : q.subject === 'mathematics' ? 'yellow' : 'purple'}-700 rounded-full text-sm font-medium capitalize">
                                    ${q.subject}
                                </span>
                                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${q.topic}</span>
                                <span class="px-3 py-1 bg-${q.difficulty === 'easy' ? 'green' : q.difficulty === 'medium' ? 'yellow' : 'red'}-100 text-${q.difficulty === 'easy' ? 'green' : q.difficulty === 'medium' ? 'yellow' : 'red'}-700 rounded-full text-sm capitalize">
                                    ${q.difficulty}
                                </span>
                            </div>
                            
                            <h4 class="font-semibold text-gray-800 mb-3">Q${q.number}. ${q.text}</h4>
                            
                            <div class="space-y-2 mb-4">
                                ${['A', 'B', 'C', 'D'].map(opt => {
                                    if (!q.options[opt]) return '';
                                    const isCorrect = opt === q.correct_option;
                                    return `
                                        <div class="${isCorrect ? 'option-correct' : 'bg-gray-100'} p-3 rounded-lg flex items-center gap-3">
                                            <span class="font-bold w-6">${isCorrect ? '‚úì' : ''} (${opt})</span>
                                            <span class="text-sm">${q.options[opt]}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${q.solution ? `
                                <div class="solution-box p-4 rounded-lg">
                                    <p class="font-semibold text-amber-800 text-sm mb-1">Solution:</p>
                                    <p class="text-amber-900 text-sm">${q.solution}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterPreview() {
            const checked = Array.from(document.querySelectorAll('#subject-filters input:checked')).map(cb => cb.dataset.subject);
            document.querySelectorAll('.question-card').forEach(card => {
                card.style.display = checked.includes(card.dataset.subject) ? 'block' : 'none';
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = document.querySelectorAll('.question-card input:checked').length;
            document.getElementById('selected-count').textContent = count;
        }
        
        function selectAll() {
            document.querySelectorAll('.question-card input').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        function deselectAll() {
            document.querySelectorAll('.question-card input').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        function saveToBank() {
            const selected = Array.from(document.querySelectorAll('.question-card input:checked')).map((cb, idx) => {
                return extractedQuestions[idx];
            }).filter(q => q);
            
            questionBank.push(...selected);
            updateBankStats();
            updateRecentActivity(selected);
            closeModal('preview-modal');
            showToast(`Saved ${selected.length} questions!`, 'success');
        }
        
        function updateBankStats() {
            const counts = { physics: 0, chemistry: 0, mathematics: 0, biology: 0 };
            questionBank.forEach(q => counts[q.subject]++);
            
            document.getElementById('count-physics').textContent = counts.physics;
            document.getElementById('count-chemistry').textContent = counts.chemistry;
            document.getElementById('count-mathematics').textContent = counts.mathematics;
            document.getElementById('count-biology').textContent = counts.biology;
            document.getElementById('total-count').textContent = questionBank.length;
        }
        
        function updateRecentActivity(questions) {
            const container = document.getElementById('recent-activity');
            const bySubject = {};
            questions.forEach(q => bySubject[q.subject] = (bySubject[q.subject] || 0) + 1);
            
            const html = `
                <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500 animate-pulse">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">Latest Extraction</p>
                            <p class="text-sm text-gray-600">${questions.length} questions ‚Ä¢ Just now</p>
                        </div>
                        <div class="text-right">
                            ${Object.entries(bySubject).map(([s, c]) => `
                                <span class="inline-block px-2 py-1 bg-white rounded text-xs font-medium capitalize mr-1">
                                    ${s}: ${c}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('afterbegin', html);
        }
        
        function exportQuestions(format) {
            const data = extractedQuestions.map(q => ({
                id: q.id,
                question: q.text,
                options: q.options,
                answer: q.correct_option,
                solution: q.solution,
                subject: q.subject,
                topic: q.topic,
                difficulty: q.difficulty
            }));
            
            let content, mime, filename;
            
            if (format === 'json') {
                content = JSON.stringify(data, null, 2);
                mime = 'application/json';
                filename = 'questions.json';
            } else {
                content = data.map(q => `
Q${q.number}. ${q.question}
A) ${q.options.A}
B) ${q.options.B}
C) ${q.options.C}
D) ${q.options.D}
Answer: ${q.answer}
Subject: ${q.subject}
Topic: ${q.topic}
                `).join('\n---\n');
                mime = 'text/plain';
                filename = 'questions.txt';
            }
            
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${data.length} questions as ${format.toUpperCase()}`, 'success');
        }
        
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) closeModal(e.target.id);
        }
    </script>
</body>
</html>