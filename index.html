<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Bank Pro - Subject-wise PDF Processor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subject-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .subject-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .subject-card.active {
            ring: 4px;
            transform: scale(1.02);
        }
        
        .upload-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: currentColor;
            background: opacity 0.1;
        }
        
        .option-correct {
            background: linear-gradient(90deg, #d1fae5, #a7f3d0);
            border-left: 4px solid #10b981;
        }
        
        .solution-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal.active { display: flex; align-items: center; justify-content: center; }
        
        .toast {
            position: fixed;
            bottom: 20px; right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        
        .processing-line {
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: #e5e7eb;
        }
        
        .question-card {
            border-left: 4px solid transparent;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .question-card.physics { border-left-color: #3b82f6; }
        .question-card.chemistry { border-left-color: #10b981; }
        .question-card.mathematics { border-left-color: #f59e0b; }
        .question-card.biology { border-left-color: #8b5cf6; }
        
        .tab-active {
            border-bottom: 3px solid currentColor;
            font-weight: 600;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Toast -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="toast-message">Success</span>
    </div>

    <!-- Processing Modal -->
    <div id="processing-modal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">Processing <span id="proc-subject" class="capitalize"></span> PDF</h3>
                    <p class="text-gray-500" id="processing-filename">document.pdf</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-blue-600" id="processing-percent">0%</div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-4 relative">
                <div class="space-y-6" id="processing-steps"></div>
            </div>
            
            <div class="mt-6 pt-6 border-t flex justify-between items-center">
                <div id="current-status" class="text-gray-600">Initializing...</div>
                <button onclick="closeModal('processing-modal')" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-7xl w-full mx-4 shadow-2xl max-h-[95vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Review <span id="preview-subject-title" class="capitalize text-blue-600"></span> Questions</h3>
                <div class="flex gap-3">
                    <button onclick="selectAll()" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg font-medium">Select All</button>
                    <button onclick="deselectAll()" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg font-medium">Deselect All</button>
                    <button onclick="closeModal('preview-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-hidden">
                <div class="h-full overflow-y-auto pr-4" id="preview-container"></div>
            </div>
            
            <div class="mt-6 pt-6 border-t flex justify-between items-center">
                <span class="text-gray-600"><span id="selected-count" class="font-bold text-xl text-blue-600">0</span> of <span id="total-preview-count">0</span> selected</span>
                <div class="flex gap-3">
                    <button onclick="exportQuestions('json')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="saveToBank()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg">
                        <i class="fas fa-save mr-2"></i>Save to Bank
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold gradient-text">Question Bank Pro</h1>
                        <p class="text-xs text-gray-500">Subject-wise PDF Processing</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="clearBank()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium text-sm">
                        <i class="fas fa-trash-alt mr-2"></i>Clear Bank
                    </button>
                    <div class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium">
                        <i class="fas fa-database mr-2"></i>
                        <span id="total-count">0</span> questions
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Hero Section -->
        <div class="bg-gradient-to-br from-indigo-900 via-blue-800 to-purple-900 rounded-3xl p-8 md:p-12 text-white mb-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-96 h-96 bg-white opacity-5 rounded-full -mr-48 -mt-48"></div>
            
            <div class="relative z-10 max-w-3xl">
                <h2 class="text-4xl md:text-5xl font-bold mb-4">Subject-Wise Processing</h2>
                <p class="text-xl text-blue-100 mb-6">Select a subject and upload your PDF. We'll extract all MCQs, match solutions, and organize them perfectly.</p>
                
                <div class="flex flex-wrap gap-3">
                    <span class="px-4 py-2 bg-white/10 rounded-full text-sm backdrop-blur"><i class="fas fa-check mr-2"></i>No misclassification</span>
                    <span class="px-4 py-2 bg-white/10 rounded-full text-sm backdrop-blur"><i class="fas fa-check mr-2"></i>Subject-locked extraction</span>
                    <span class="px-4 py-2 bg-white/10 rounded-full text-sm backdrop-blur"><i class="fas fa-check mr-2"></i>Auto topic detection</span>
                </div>
            </div>
        </div>

        <!-- Subject Selection Grid -->
        <div class="mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <i class="fas fa-th-large text-blue-600"></i> Select Subject to Upload
            </h3>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Physics -->
                <div class="subject-card bg-white rounded-2xl shadow-sm overflow-hidden border-2 border-transparent hover:border-blue-500" 
                     onclick="selectSubject('physics')" id="card-physics">
                    <div class="h-2 bg-blue-500"></div>
                    <div class="p-6">
                        <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center text-3xl mb-4">‚öõÔ∏è</div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Physics</h4>
                        <p class="text-sm text-gray-600 mb-4">Mechanics, Electricity, Magnetism, Optics, Modern Physics</p>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-blue-600" id="card-count-physics">0</span>
                            <span class="text-sm text-gray-500">questions</span>
                        </div>
                        
                        <button class="w-full mt-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Upload Physics PDF
                        </button>
                    </div>
                </div>

                <!-- Chemistry -->
                <div class="subject-card bg-white rounded-2xl shadow-sm overflow-hidden border-2 border-transparent hover:border-green-500" 
                     onclick="selectSubject('chemistry')" id="card-chemistry">
                    <div class="h-2 bg-green-500"></div>
                    <div class="p-6">
                        <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center text-3xl mb-4">üß™</div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Chemistry</h4>
                        <p class="text-sm text-gray-600 mb-4">Physical, Organic, Inorganic, Equilibrium, Electrochemistry</p>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-green-600" id="card-count-chemistry">0</span>
                            <span class="text-sm text-gray-500">questions</span>
                        </div>
                        
                        <button class="w-full mt-4 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Upload Chemistry PDF
                        </button>
                    </div>
                </div>

                <!-- Mathematics -->
                <div class="subject-card bg-white rounded-2xl shadow-sm overflow-hidden border-2 border-transparent hover:border-yellow-500" 
                     onclick="selectSubject('mathematics')" id="card-mathematics">
                    <div class="h-2 bg-yellow-500"></div>
                    <div class="p-6">
                        <div class="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center text-3xl mb-4">üìê</div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Mathematics</h4>
                        <p class="text-sm text-gray-600 mb-4">Algebra, Calculus, Geometry, Trigonometry, Statistics</p>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-yellow-600" id="card-count-mathematics">0</span>
                            <span class="text-sm text-gray-500">questions</span>
                        </div>
                        
                        <button class="w-full mt-4 py-3 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600 transition flex items-center justify-center gap-2">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Upload Math PDF
                        </button>
                    </div>
                </div>

                <!-- Biology -->
                <div class="subject-card bg-white rounded-2xl shadow-sm overflow-hidden border-2 border-transparent hover:border-purple-500" 
                     onclick="selectSubject('biology')" id="card-biology">
                    <div class="h-2 bg-purple-500"></div>
                    <div class="p-6">
                        <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center text-3xl mb-4">üß¨</div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Biology</h4>
                        <p class="text-sm text-gray-600 mb-4">Cell Biology, Genetics, Ecology, Human Physiology</p>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-purple-600" id="card-count-biology">0</span>
                            <span class="text-sm text-gray-500">questions</span>
                        </div>
                        
                        <button class="w-full mt-4 py-3 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Upload Biology PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Upload Interface (Hidden by default) -->
        <div id="subject-upload-section" class="hidden mb-8">
            <div class="bg-white rounded-2xl shadow-sm p-6 border-2" id="upload-section-border">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" id="upload-icon">‚öõÔ∏è</div>
                        <div>
                            <h3 class="text-2xl font-bold capitalize" id="upload-title">Physics Upload</h3>
                            <p class="text-gray-600">Upload NCERT, HC Verma, or question papers</p>
                        </div>
                    </div>
                    <button onclick="closeSubjectUpload()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Upload Zone -->
                <div class="upload-zone rounded-2xl p-12 text-center cursor-pointer mb-6 transition-all" 
                     ondrop="handleSubjectDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                     onclick="document.getElementById('subject-pdf-input').click()"
                     id="subject-upload-zone">
                    <input type="file" id="subject-pdf-input" class="hidden" accept=".pdf" onchange="handleSubjectFile(event)">
                    <div class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl" id="upload-zone-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4 class="text-2xl font-bold text-gray-800 mb-3">Drop PDF here or click to browse</h4>
                    <p class="text-gray-600 mb-2">We'll extract all MCQs, find solutions, and organize by topic</p>
                    <p class="text-sm text-gray-500" id="upload-formats">Formats: NCERT, HC Verma, Previous Year Papers</p>
                </div>

                <!-- Options -->
                <div class="grid md:grid-cols-3 gap-4">
                    <label class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" checked id="sub-opt-exercises" class="w-5 h-5 rounded text-blue-600">
                        <div>
                            <p class="font-medium text-gray-800">Auto-find exercises</p>
                            <p class="text-sm text-gray-500">Detect MCQ sections</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" checked id="sub-opt-solutions" class="w-5 h-5 rounded text-blue-600">
                        <div>
                            <p class="font-medium text-gray-800">Match solutions</p>
                            <p class="text-sm text-gray-500">Link answers from solution section</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" checked id="sub-opt-topics" class="w-5 h-5 rounded text-blue-600">
                        <div>
                            <p class="font-medium text-gray-800">Detect topics</p>
                            <p class="text-sm text-gray-500">Auto-categorize by chapter</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- OR Divider -->
        <div class="flex items-center gap-4 my-8">
            <div class="flex-1 h-px bg-gray-300"></div>
            <span class="text-gray-500 font-medium">OR</span>
            <div class="flex-1 h-px bg-gray-300"></div>
        </div>

        <!-- Multi-Subject Upload -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-magic text-purple-600"></i> Multi-Subject Upload
            </h3>
            <p class="text-gray-600 mb-4">Upload a complete question paper (JEE/NEET/CET) and we'll auto-classify into all 4 subjects</p>
            
            <div class="upload-zone rounded-xl p-8 text-center cursor-pointer border-gray-300" 
                 ondrop="handleMultiDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                 onclick="document.getElementById('multi-pdf-input').click()">
                <input type="file" id="multi-pdf-input" class="hidden" accept=".pdf" onchange="handleMultiFile(event)">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-600 text-2xl">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h4 class="font-semibold text-gray-800">Upload Mixed Subject Paper</h4>
                <p class="text-sm text-gray-500">JEE Main, NEET, CET, or custom test papers</p>
            </div>
        </div>

        <!-- Repository Stats -->
        <div class="mt-8 bg-white rounded-2xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-6">Repository Overview</h3>
            
            <div class="grid md:grid-cols-4 gap-6">
                <div class="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-600 font-bold">Physics</span>
                        <span class="text-2xl font-bold text-blue-700" id="stat-physics">0</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full transition-all" id="bar-physics" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="bg-green-50 rounded-xl p-4 border-l-4 border-green-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-green-600 font-bold">Chemistry</span>
                        <span class="text-2xl font-bold text-green-700" id="stat-chemistry">0</span>
                    </div>
                    <div class="w-full bg-green-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full transition-all" id="bar-chemistry" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 rounded-xl p-4 border-l-4 border-yellow-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-yellow-600 font-bold">Mathematics</span>
                        <span class="text-2xl font-bold text-yellow-700" id="stat-mathematics">0</span>
                    </div>
                    <div class="w-full bg-yellow-200 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full transition-all" id="bar-mathematics" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="bg-purple-50 rounded-xl p-4 border-l-4 border-purple-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-purple-600 font-bold">Biology</span>
                        <span class="text-2xl font-bold text-purple-700" id="stat-biology">0</span>
                    </div>
                    <div class="w-full bg-purple-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full transition-all" id="bar-biology" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="mt-8 bg-white rounded-2xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Uploads</h3>
            <div id="recent-activity" class="space-y-3">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                    <p>No uploads yet</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // State
        let currentSubject = null;
        let extractedQuestions = [];
        let questionBank = JSON.parse(localStorage.getItem('questionBank') || '[]');
        
        // Subject configurations
        const subjectConfig = {
            physics: {
                icon: '‚öõÔ∏è',
                color: 'blue',
                topics: ['Mechanics', 'Electrostatics', 'Current Electricity', 'Magnetism', 'Optics', 'Modern Physics'],
                keywords: ['force', 'velocity', 'acceleration', 'mass', 'newton', 'energy', 'work', 'power', 'electric', 'magnetic', 'field', 'potential', 'capacitor', 'resistance', 'current', 'voltage', 'circuit', 'light', 'lens', 'mirror', 'wave', 'atom', 'nuclear', 'electron', 'photon']
            },
            chemistry: {
                icon: 'üß™',
                color: 'green',
                topics: ['Physical Chemistry', 'Organic Chemistry', 'Inorganic Chemistry'],
                keywords: ['reaction', 'molecule', 'atom', 'element', 'compound', 'acid', 'base', 'mole', 'concentration', 'equilibrium', 'oxidation', 'reduction', 'organic', 'hydrocarbon', 'alcohol', 'aldehyde', 'ketone', 'periodic', 'bond', 'metal']
            },
            mathematics: {
                icon: 'üìê',
                color: 'yellow',
                topics: ['Algebra', 'Calculus', 'Coordinate Geometry', 'Trigonometry', 'Vectors'],
                keywords: ['equation', 'function', 'derivative', 'integral', 'limit', 'matrix', 'vector', 'probability', 'geometry', 'algebra', 'calculus', 'trigonometry', 'logarithm', 'polynomial', 'sequence', 'series']
            },
            biology: {
                icon: 'üß¨',
                color: 'purple',
                topics: ['Cell Biology', 'Genetics', 'Ecology', 'Human Physiology', 'Plant Physiology'],
                keywords: ['cell', 'tissue', 'organ', 'gene', 'dna', 'rna', 'chromosome', 'protein', 'enzyme', 'photosynthesis', 'respiration', 'ecosystem', 'evolution', 'human', 'plant', 'animal', 'microorganism']
            }
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateAllStats();
            loadRecent();
        });
        
        // UI Functions
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            t.innerHTML = `<i class="fas fa-${icon} mr-2"></i><span>${msg}</span>`;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // Subject Selection
        function selectSubject(subject) {
            currentSubject = subject;
            const config = subjectConfig[subject];
            
            // Show upload section
            const section = document.getElementById('subject-upload-section');
            section.classList.remove('hidden');
            
            // Style based on subject
            document.getElementById('upload-section-border').className = `bg-white rounded-2xl shadow-sm p-6 border-2 border-${config.color}-500`;
            document.getElementById('upload-icon').className = `w-12 h-12 bg-${config.color}-100 rounded-xl flex items-center justify-center text-2xl`;
            document.getElementById('upload-icon').textContent = config.icon;
            document.getElementById('upload-title').textContent = `${subject.charAt(0).toUpperCase() + subject.slice(1)} Upload`;
            document.getElementById('upload-title').className = `text-2xl font-bold capitalize text-${config.color}-600`;
            
            // Upload zone styling
            const zone = document.getElementById('subject-upload-zone');
            zone.className = `upload-zone rounded-2xl p-12 text-center cursor-pointer mb-6 border-${config.color}-300 hover:border-${config.color}-500 hover:bg-${config.color}-50`;
            document.getElementById('upload-zone-icon').className = `w-24 h-24 bg-${config.color}-100 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl text-${config.color}-600`;
            
            // Scroll to upload section
            section.scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeSubjectUpload() {
            document.getElementById('subject-upload-section').classList.add('hidden');
            currentSubject = null;
        }
        
        // File Handling
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        
        function handleSubjectDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file?.type === 'application/pdf') {
                processSubjectPDF(file, currentSubject);
            } else {
                showToast('Please upload a PDF file', 'error');
            }
        }
        
        function handleSubjectFile(e) {
            const file = e.target.files[0];
            if (file) processSubjectPDF(file, currentSubject);
        }
        
        function handleMultiDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file?.type === 'application/pdf') {
                processMultiPDF(file);
            }
        }
        
        function handleMultiFile(e) {
            const file = e.target.files[0];
            if (file) processMultiPDF(file);
        }
        
        // PDF Processing - Subject Specific
        async function processSubjectPDF(file, subject) {
            document.getElementById('processing-filename').textContent = file.name;
            document.getElementById('proc-subject').textContent = subject;
            document.getElementById('processing-percent').textContent = '0%';
            
            const steps = [
                { name: 'Reading PDF', desc: 'Loading pages...' },
                { name: 'Finding Exercises', desc: 'Locating MCQ sections...' },
                { name: 'Extracting Questions', desc: 'Parsing Q&A...' },
                { name: 'Finding Solutions', desc: 'Matching answers...' },
                { name: 'Detecting Topics', desc: 'Categorizing by chapter...' },
                { name: 'Finalizing', desc: 'Preparing preview...' }
            ];
            
            renderSteps(steps);
            openModal('processing-modal');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdf.numPages;
                
                // Read all pages
                updateStep(0, 'active');
                const pageTexts = [];
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const text = reconstructText(content.items);
                    pageTexts.push({ page: i, text });
                    
                    const pct = Math.round((i / numPages) * 15);
                    document.getElementById('processing-percent').textContent = `${pct}%`;
                    document.getElementById('current-status').textContent = `Reading page ${i}/${numPages}`;
                }
                completeStep(0);
                
                // Find exercises
                updateStep(1, 'active');
                const exercises = findExercises(pageTexts);
                document.getElementById('step-desc-1').textContent = `Found ${exercises.length} MCQ sections`;
                completeStep(1);
                
                // Extract questions
                updateStep(2, 'active');
                let questions = extractQuestions(pageTexts, exercises);
                questions = questions.map(q => ({ ...q, subject: subject })); // Lock subject
                document.getElementById('step-desc-2').textContent = `Extracted ${questions.length} questions`;
                completeStep(2);
                
                // Match solutions
                updateStep(3, 'active');
                if (document.getElementById('sub-opt-solutions').checked) {
                    const solutions = findSolutions(pageTexts);
                    questions = matchSolutions(questions, solutions);
                }
                completeStep(3);
                
                // Detect topics
                updateStep(4, 'active');
                questions = detectTopics(questions, subject);
                const topicCounts = {};
                questions.forEach(q => {
                    topicCounts[q.topic] = (topicCounts[q.topic] || 0) + 1;
                });
                document.getElementById('step-desc-4').textContent = Object.entries(topicCounts).map(([t, c]) => `${t}: ${c}`).join(', ');
                completeStep(4);
                
                // Finalize
                updateStep(5, 'active');
                extractedQuestions = questions.map((q, idx) => ({
                    ...q,
                    id: `${subject.toUpperCase()}_${Date.now()}_${idx}`,
                    extractIndex: idx
                }));
                document.getElementById('processing-percent').textContent = '100%';
                completeStep(5);
                
                setTimeout(() => {
                    closeModal('processing-modal');
                    showPreview(subject);
                }, 500);
                
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                closeModal('processing-modal');
            }
        }
        
        // Multi-subject processing
        async function processMultiPDF(file) {
            document.getElementById('processing-filename').textContent = file.name;
            document.getElementById('proc-subject').textContent = 'Multi-Subject';
            document.getElementById('processing-percent').textContent = '0%';
            
            const steps = [
                { name: 'Reading PDF', desc: 'Loading all pages...' },
                { name: 'Detecting Subjects', desc: 'Identifying Physics/Chem/Math/Bio sections...' },
                { name: 'Extracting Questions', desc: 'Parsing all MCQs...' },
                { name: 'Classifying', desc: 'Sorting by subject...' },
                { name: 'Matching Solutions', desc: 'Finding answers...' },
                { name: 'Finalizing', desc: 'Preparing preview...' }
            ];
            
            renderSteps(steps);
            openModal('processing-modal');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdf.numPages;
                
                // Read pages
                updateStep(0, 'active');
                const pageTexts = [];
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const text = reconstructText(content.items);
                    pageTexts.push({ page: i, text });
                    
                    const pct = Math.round((i / numPages) * 10);
                    document.getElementById('processing-percent').textContent = `${pct}%`;
                }
                completeStep(0);
                
                // Detect subjects per page
                updateStep(1, 'active');
                const pageSubjects = detectPageSubjects(pageTexts);
                completeStep(1);
                
                // Extract all questions
                updateStep(2, 'active');
                let questions = extractQuestions(pageTexts, []);
                completeStep(2);
                
                // Classify by subject
                updateStep(3, 'active');
                questions = classifyBySubject(questions, pageSubjects);
                const counts = countBySubject(questions);
                document.getElementById('step-desc-3').textContent = `Physics: ${counts.physics}, Chem: ${counts.chemistry}, Math: ${counts.mathematics}, Bio: ${counts.biology}`;
                completeStep(3);
                
                // Match solutions
                updateStep(4, 'active');
                const solutions = findSolutions(pageTexts);
                questions = matchSolutions(questions, solutions);
                completeStep(4);
                
                // Finalize
                updateStep(5, 'active');
                extractedQuestions = questions.map((q, idx) => ({
                    ...q,
                    id: `MIX_${Date.now()}_${idx}`,
                    extractIndex: idx
                }));
                document.getElementById('processing-percent').textContent = '100%';
                completeStep(5);
                
                setTimeout(() => {
                    closeModal('processing-modal');
                    showPreview('mixed');
                }, 500);
                
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                closeModal('processing-modal');
            }
        }
        
        // Helper functions
        function renderSteps(steps) {
            document.getElementById('processing-steps').innerHTML = steps.map((s, i) => `
                <div class="relative pl-12 ${i > 0 ? 'opacity-50' : ''}" id="step-${i}">
                    ${i < steps.length - 1 ? '<div class="processing-line"></div>' : ''}
                    <div class="absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-pending" id="step-icon-${i}">
                        ${i + 1}
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">${s.name}</h4>
                        <p class="text-sm text-gray-500" id="step-desc-${i}">${s.desc}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function updateStep(n, status) {
            const icon = document.getElementById(`step-icon-${n}`);
            icon.className = `absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-${status}`;
            if (status === 'active') icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        function completeStep(n) {
            const step = document.getElementById(`step-${n}`);
            const icon = document.getElementById(`step-icon-${n}`);
            icon.className = 'absolute left-0 top-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-completed';
            icon.innerHTML = '<i class="fas fa-check"></i>';
            step.classList.remove('opacity-50');
        }
        
        function reconstructText(items) {
            let text = '';
            let lastY = null;
            items.forEach(item => {
                const y = item.transform[5];
                if (lastY !== null && Math.abs(y - lastY) > 5) text += '\n';
                text += item.str + ' ';
                lastY = y;
            });
            return text.replace(/\s+/g, ' ').trim();
        }
        
        function findExercises(pageTexts) {
            const patterns = [/exercise/i, /mcq/i, /multiple\s*choice/i, /objective/i, /practice/i];
            return pageTexts.filter(({text}) => patterns.some(p => p.test(text)));
        }
        
        function extractQuestions(pageTexts, exercises) {
            const questions = [];
            let qNum = 1;
            const sources = exercises.length > 0 ? exercises : pageTexts;
            
            sources.forEach(({page, text}) => {
                const pattern = /(?:^|\n)\s*(\d+)[\.\)]\s+([^\n]+?)(?=(?:\n\s*\d+[\.\)]|\n\s*\(?[A-Da-d]\)?[\.\)]|\n\s*$))/gms;
                let match;
                
                while ((match = pattern.exec(text)) !== null) {
                    const qText = match[2].trim();
                    if (qText.length < 10) continue;
                    
                    const afterQ = text.substring(match.index + match[0].length);
                    const options = extractOptions(afterQ);
                    
                    if (Object.keys(options).length >= 2) {
                        questions.push({
                            number: qNum++,
                            text: qText,
                            options,
                            page,
                            correct_option: '',
                            solution: ''
                        });
                    }
                }
            });
            
            return questions;
        }
        
        function extractOptions(text) {
            const options = {};
            const patterns = [
                /\(?([A-Da-d])\)?[\.\)]\s*([^\(\)\n]+?)(?=\s*\(?[A-Da-d]\)?[\.\)]|\s*(?:Answer|Solution)|\n\s*\d+[\.\)]|$)/g,
                /(?:^|\n)\s*([A-Da-d])[\.\)]\s+([^\n]+?)(?=(?:\n\s*[A-Da-d][\.\)]|\n\s*(?:Answer|Solution)|\n\s*\d+[\.\)]|$))/g
            ];
            
            for (const pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const opt = match[1].toUpperCase();
                    if (!options[opt]) options[opt] = match[2].trim();
                }
                if (Object.keys(options).length >= 2) break;
            }
            
            return options;
        }
        
        function findSolutions(pageTexts) {
            const solutions = [];
            const solPages = pageTexts.filter(({text}) => /answer|solution/i.test(text));
            
            solPages.forEach(({page, text}) => {
                const pattern = /(?:Q\.?)?\s*(\d+)[\.\)]?\s*(?:Ans(?:wer)?[:.]?\s*)?\(?([A-Da-d])\)?/gi;
                let match;
                
                while ((match = pattern.exec(text)) !== null) {
                    const after = text.substring(match.index + match[0].length, match.index + 400);
                    const solEnd = after.search(/\n\s*(?:\d+|Q\.?\s*\d+|Ans|Sol)/);
                    const solution = (solEnd > 0 ? after.substring(0, solEnd) : after).trim();
                    
                    solutions.push({
                        questionNumber: parseInt(match[1]),
                        answer: match[2].toUpperCase(),
                        solution,
                        page
                    });
                }
            });
            
            return solutions;
        }
        
        function matchSolutions(questions, solutions) {
            return questions.map(q => {
                const sol = solutions.find(s => 
                    s.questionNumber === q.number || 
                    Math.abs(s.questionNumber - q.number) <= 2 ||
                    Math.abs(s.page - q.page) <= 3
                );
                
                return sol ? { ...q, correct_option: sol.answer, solution: sol.solution, matchedPage: sol.page } : q;
            });
        }
        
        function detectTopics(questions, subject) {
            const topics = subjectConfig[subject].topics;
            const keywords = subjectConfig[subject].keywords;
            
            return questions.map(q => {
                const text = (q.text + ' ' + Object.values(q.options).join(' ')).toLowerCase();
                
                // Score each topic
                const scores = {};
                topics.forEach(topic => {
                    // Simple keyword matching for demo
                    const topicKeywords = {
                        'Mechanics': ['force', 'motion', 'velocity', 'acceleration', 'newton', 'momentum', 'energy', 'work'],
                        'Electrostatics': ['electric', 'charge', 'field', 'potential', 'capacitor', 'coulomb'],
                        'Current Electricity': ['current', 'resistance', 'ohm', 'circuit', 'voltage', 'kirchhoff'],
                        'Magnetism': ['magnetic', 'induction', 'faraday', 'transformer', 'alternating'],
                        'Optics': ['light', 'lens', 'mirror', 'reflection', 'refraction'],
                        'Modern Physics': ['atom', 'nuclear', 'photon', 'electron', 'quantum', 'radioactive'],
                        'Physical Chemistry': ['mole', 'concentration', 'equilibrium', 'kinetics', 'thermodynamics'],
                        'Organic Chemistry': ['organic', 'hydrocarbon', 'alcohol', 'aldehyde', 'ketone', 'acid'],
                        'Inorganic Chemistry': ['periodic', 'element', 'compound', 'coordination', 'metallurgy'],
                        'Algebra': ['equation', 'polynomial', 'complex', 'sequence', 'permutation'],
                        'Calculus': ['derivative', 'integral', 'limit', 'differentiation'],
                        'Coordinate Geometry': ['coordinate', 'circle', 'parabola', 'ellipse'],
                        'Trigonometry': ['sin', 'cos', 'tan', 'trigonometric'],
                        'Vectors': ['vector', 'scalar', 'product', '3d'],
                        'Cell Biology': ['cell', 'nucleus', 'mitochondria', 'division'],
                        'Genetics': ['dna', 'rna', 'gene', 'chromosome', 'heredity'],
                        'Ecology': ['ecosystem', 'food', 'chain', 'biodiversity'],
                        'Human Physiology': ['digestion', 'respiration', 'circulation', 'nervous'],
                        'Plant Physiology': ['photosynthesis', 'transpiration', 'xylem', 'phloem']
                    }[topic] || [];
                    
                    scores[topic] = topicKeywords.filter(k => text.includes(k)).length;
                });
                
                const bestTopic = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];
                const topic = bestTopic && bestTopic[1] > 0 ? bestTopic[0] : 'General';
                
                // Difficulty
                const words = text.split(/\s+/).length;
                const difficulty = words > 60 ? 'hard' : words > 30 ? 'medium' : 'easy';
                
                return { ...q, topic, difficulty };
            });
        }
        
        function detectPageSubjects(pageTexts) {
            return pageTexts.map(({page, text}) => {
                const lower = text.toLowerCase();
                const scores = {};
                
                Object.entries(subjectConfig).forEach(([subj, config]) => {
                    scores[subj] = config.keywords.filter(k => lower.includes(k)).length;
                });
                
                const best = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];
                return { page, subject: best[1] > 2 ? best[0] : 'unknown' };
            });
        }
        
        function classifyBySubject(questions, pageSubjects) {
            return questions.map(q => {
                const pageSubj = pageSubjects.find(p => p.page === q.page);
                const text = (q.text + ' ' + Object.values(q.options).join(' ')).toLowerCase();
                
                // If page has clear subject, use it
                if (pageSubj && pageSubj.subject !== 'unknown') {
                    return { ...q, subject: pageSubj.subject };
                }
                
                // Otherwise classify by content
                const scores = {};
                Object.entries(subjectConfig).forEach(([subj, config]) => {
                    scores[subj] = config.keywords.filter(k => text.includes(k)).length;
                });
                
                const best = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];
                return { ...q, subject: best[0] };
            });
        }
        
        function countBySubject(questions) {
            const counts = { physics: 0, chemistry: 0, mathematics: 0, biology: 0 };
            questions.forEach(q => { if (counts[q.subject] !== undefined) counts[q.subject]++; });
            return counts;
        }
        
        // Preview
        function showPreview(subject) {
            document.getElementById('preview-subject-title').textContent = subject === 'mixed' ? 'Mixed Subject' : subject;
            
            const container = document.getElementById('preview-container');
            container.innerHTML = extractedQuestions.map((q, idx) => `
                <div class="question-card ${q.subject} bg-white rounded-xl border border-gray-200 p-6 mb-4" data-index="${idx}">
                    <div class="flex items-start gap-4">
                        <input type="checkbox" checked onchange="updateSelectedCount()" class="question-checkbox mt-1 w-5 h-5 rounded text-blue-600">
                        <div class="flex-1">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-3 py-1 bg-${q.subject === 'physics' ? 'blue' : q.subject === 'chemistry' ? 'green' : q.subject === 'mathematics' ? 'yellow' : 'purple'}-100 text-${q.subject === 'physics' ? 'blue' : q.subject === 'chemistry' ? 'green' : q.subject === 'mathematics' ? 'yellow' : 'purple'}-700 rounded-full text-sm font-bold capitalize">
                                    ${q.subject}
                                </span>
                                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${q.topic}</span>
                                <span class="px-3 py-1 bg-${q.difficulty === 'easy' ? 'green' : q.difficulty === 'medium' ? 'yellow' : 'red'}-100 text-${q.difficulty === 'easy' ? 'green' : q.difficulty === 'medium' ? 'yellow' : 'red'}-700 rounded-full text-sm font-bold capitalize">
                                    ${q.difficulty}
                                </span>
                            </div>
                            
                            <h4 class="font-semibold text-gray-800 mb-3">Q${q.number}. ${q.text}</h4>
                            
                            <div class="space-y-2 mb-4">
                                ${['A', 'B', 'C', 'D'].map(opt => {
                                    if (!q.options[opt]) return '';
                                    const isCorrect = opt === q.correct_option;
                                    return `
                                        <div class="${isCorrect ? 'option-correct' : 'bg-gray-50'} p-3 rounded-lg flex items-center gap-3">
                                            <span class="font-bold w-6">${isCorrect ? '‚úì' : ''} (${opt})</span>
                                            <span class="text-sm">${q.options[opt]}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${q.correct_option ? `
                                <div class="bg-green-50 text-green-800 px-4 py-2 rounded-lg inline-block mb-3 font-medium">
                                    Answer: ${q.correct_option}
                                </div>
                            ` : '<p class="text-orange-600 text-sm mb-3"><i class="fas fa-exclamation-triangle mr-1"></i>No answer found</p>'}
                            
                            ${q.solution ? `
                                <div class="solution-box p-4 rounded-lg">
                                    <p class="font-bold text-amber-800 mb-1">Solution:</p>
                                    <p class="text-amber-900 text-sm">${q.solution}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateSelectedCount();
            openModal('preview-modal');
        }
        
        function updateSelectedCount() {
            const total = document.querySelectorAll('.question-checkbox').length;
            const checked = document.querySelectorAll('.question-checkbox:checked').length;
            document.getElementById('selected-count').textContent = checked;
            document.getElementById('total-preview-count').textContent = total;
        }
        
        function selectAll() {
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        function deselectAll() {
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        function saveToBank() {
            const checkboxes = document.querySelectorAll('.question-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => {
                const idx = parseInt(cb.closest('.question-card').dataset.index);
                return extractedQuestions[idx];
            });
            
            if (selected.length === 0) {
                showToast('No questions selected', 'error');
                return;
            }
            
            const toAdd = selected.map(q => ({
                ...q,
                id: `QB_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                addedAt: new Date().toISOString()
            }));
            
            questionBank.push(...toAdd);
            localStorage.setItem('questionBank', JSON.stringify(questionBank));
            
            updateAllStats();
            addToRecent(toAdd);
            
            closeModal('preview-modal');
            showToast(`Saved ${selected.length} questions!`, 'success');
        }
        
        function exportQuestions(format) {
            const selected = Array.from(document.querySelectorAll('.question-checkbox:checked')).map(cb => {
                const idx = parseInt(cb.closest('.question-card').dataset.index);
                return extractedQuestions[idx];
            });
            
            const data = selected.map(q => ({
                id: q.id,
                question: q.text,
                options: q.options,
                answer: q.correct_option,
                solution: q.solution,
                subject: q.subject,
                topic: q.topic,
                difficulty: q.difficulty
            }));
            
            const content = format === 'json' 
                ? JSON.stringify(data, null, 2)
                : 'data:text/csv;charset=utf-8,' + [
                    'ID,Subject,Topic,Question,A,B,C,D,Answer,Solution,Difficulty',
                    ...data.map(q => `"${q.id}","${q.subject}","${q.topic}","${q.question}","${q.options.A||''}","${q.options.B||''}","${q.options.C||''}","${q.options.D||''}","${q.answer||''}","${q.solution||''}","${q.difficulty}"`)
                ].join('\n');
            
            const blob = new Blob([content], { type: format === 'json' ? 'application/json' : 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questions_${Date.now()}.${format}`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Stats and storage
        function updateAllStats() {
            const counts = { physics: 0, chemistry: 0, mathematics: 0, biology: 0 };
            questionBank.forEach(q => { if (counts[q.subject] !== undefined) counts[q.subject]++; });
            
            const total = questionBank.length;
            
            // Update stat cards
            Object.entries(counts).forEach(([subj, count]) => {
                document.getElementById(`stat-${subj}`).textContent = count;
                document.getElementById(`card-count-${subj}`).textContent = count;
                const pct = total > 0 ? (count / total * 100) : 0;
                document.getElementById(`bar-${subj}`).style.width = `${pct}%`;
            });
            
            document.getElementById('total-count').textContent = total;
        }
        
        function addToRecent(questions) {
            const bySubject = {};
            questions.forEach(q => bySubject[q.subject] = (bySubject[q.subject] || 0) + 1);
            
            const recent = JSON.parse(localStorage.getItem('recentUploads') || '[]');
            recent.unshift({
                filename: document.getElementById('processing-filename').textContent,
                count: questions.length,
                bySubject,
                time: new Date().toISOString()
            });
            
            if (recent.length > 5) recent.pop();
            localStorage.setItem('recentUploads', JSON.stringify(recent));
            loadRecent();
        }
        
        function loadRecent() {
            const recent = JSON.parse(localStorage.getItem('recentUploads') || '[]');
            const container = document.getElementById('recent-activity');
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-3 opacity-50"></i><p>No uploads yet</p></div>';
                return;
            }
            
            container.innerHTML = recent.map(r => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-bold text-gray-800 truncate max-w-xs">${r.filename}</p>
                        <p class="text-sm text-gray-600">${r.count} questions ‚Ä¢ ${timeAgo(r.time)}</p>
                    </div>
                    <div class="flex gap-2">
                        ${Object.entries(r.bySubject).map(([s, c]) => `
                            <span class="px-2 py-1 bg-${s === 'physics' ? 'blue' : s === 'chemistry' ? 'green' : s === 'mathematics' ? 'yellow' : 'purple'}-100 text-${s === 'physics' ? 'blue' : s === 'chemistry' ? 'green' : s === 'mathematics' ? 'yellow' : 'purple'}-600 rounded text-xs font-bold">
                                ${s.charAt(0).toUpperCase()}: ${c}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function timeAgo(iso) {
            const sec = Math.floor((new Date() - new Date(iso)) / 1000);
            if (sec < 60) return 'just now';
            const min = Math.floor(sec / 60);
            if (min < 60) return `${min}m ago`;
            const hr = Math.floor(min / 60);
            if (hr < 24) return `${hr}h ago`;
            return `${Math.floor(hr / 24)}d ago`;
        }
        
        function clearBank() {
            if (!confirm('Clear all questions?')) return;
            questionBank = [];
            localStorage.removeItem('questionBank');
            updateAllStats();
            showToast('Bank cleared', 'success');
        }
        
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) closeModal(e.target.id);
        }
    </script>
</body>
</html>
